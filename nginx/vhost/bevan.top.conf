

lua_shared_dict healthcheck 1m;

lua_socket_log_errors off;
lua_code_cache off;
#upstream api.com {
#   server 127.0.0.1:81;
#   server 127.0.0.1:83;     
#}

include /data/wwwroot/bevan.top/config/upstream/upstream.conf;

#init_by_lua_file /data/wwwroot/bevan.top/lua/init.lua;

#init_worker_by_lua_file /data/wwwroot/bevan.top/lua/health_check.lua;
init_worker_by_lua_file $lua_base_path/health_check.lua;

#header_filter_by_lua_file /data/wwwroot/bevan.top/lua/header_handle.lua;
header_filter_by_lua_file $lua_base_path/header_handle.lua;

#log_by_lua_file /data/wwwroot/bevan.top/lua/log.lua;
log_by_lua_file $lua_base_path/log.lua;

server {
  listen 80;
  server_name bevan.top 127.0.0.1;
  access_log /data/wwwlogs/bevan.top_nginx.log main;
  index index.html index.htm index.php;
  root /data/wwwroot/bevan.top/public/;
  default_type appliction/json;
  
  #lua_package_path "/usr/local/openresty/lualib/?.lua;;";
  #lua_package_cpath "/usr/local/openresty/lualib/?.so;;";
  include /usr/local/openresty/nginx/conf/rewrite/laravel.conf;
  error_page 405 444 404 403 401 402 /404.html;
  #error_page 502 /502.html;

  error_log /data/wwwlogs/bevan.top_error.log error;


  resolver 8.8.8.8;

  location = /health_status {
    access_log off;
    set $flag 1; 
    default_type text/plain;
    allow 127.0.0.1;
    deny all;
    #content_by_lua_file /data/wwwroot/bevan.top/lua/health_check.lua;
    content_by_lua_file $lua_base_path/health_check.lua;
    #content_by_lua_block {
    #   local hc = require "resty.upstream.healthcheck"
    #   ngx.say("Nginx Worker PID: ", ngx.worker.pid())
    #   ngx.print(hc.status_page())
    #}
  }

  location /testHealth {
     set $flag 1;
     content_by_lua_file $lua_base_path/health_check.lua;
  } 

  location /token {
     content_by_lua_file $lua_base_path/jwt.lua;
  }

  location /sign {
     content_by_lua_file $lua_base_path/sign.lua;
  }

  location /verifty {
    content_by_lua_file $lua_base_path/jwt_validate.lua;
  }

  location = /404.html {
    content_by_lua_file $lua_base_path/40x.lua;
  }

  location = /testLuaTool {
     content_by_lua_file $lua_base_path/tool.lua;
  }

  location ~ /internal/(.*) {
     internal;
     proxy_http_version 1.1;
     #proxy_pass http://127.0.0.1:81/$1$is_args$args;
     proxy_pass http://api.com/$1$is_args$args;
     proxy_set_header Host      $host;
     proxy_set_header X-Real-IP $remote_addr;
     proxy_set_header X-Forwarded-For $remote_addr;
     #proxy_pass_request_headers off;
  }

  location ~ [^/]\.php(/|$) {
    #fastcgi_pass remote_php_ip:9000;
    fastcgi_pass unix:/dev/shm/php-cgi.sock;
    fastcgi_index index.php;
    include fastcgi.conf;
  }
 
  location @server {
  }

  location ~ ^/api/(.*)$ {
    #access_by_lua_file /data/wwwroot/bevan.top/lua/ip_blacklist.lua;
    content_by_lua_file $lua_base_path/proxy.lua;
  }

  location ~ ^/multiApi/(.*)$ {
    content_by_lua_file $lua_base_path/proxy_multi.lua;
  }

#  location = /favicon.ico { access_log off; log_not_found off; }
#  location = /robots.txt  { access_log off; log_not_found off; }


  location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|flv|mp4|ico)$ {
    expires 30d;
    access_log off;
  }
  location ~ .*\.(js|css)?$ {
    expires 7d;
    access_log off;
  }
  location ~ /\.ht {
    deny all;
  }

  location = /fpm_status {
    allow 127.0.0.1;
    deny all;
    fastcgi_param SCRIPT_FILENAME $fastcgi_script_name;
    include fastcgi.conf;
    fastcgi_pass unix:/dev/shm/php-cgi.sock;
  }
  location = /status {
     allow 127.0.0.1;
     deny all;
     stub_status on;
     access_log on;
     access_log /data/wwwlogs/status.log;
     auth_basic "NginxStatus";
  }
}
